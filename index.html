<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Buscador de Suministros</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
	#panelAtenciones.hidden {
  	display: none !important;
	}
  body { margin: 0; height: 100vh; display: flex; overflow: hidden; }
  #sidebar { width: 320px; background: #f8f9fa; padding: 15px; overflow-y: auto; transition: all 0.3s ease; }
  #sidebar.hidden { transform: translateX(-100%); }
  #map { flex: 1; }
  .fade-in { animation: fadeIn 0.5s ease-in-out; }
  @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
  .toggle-btn { position: absolute; top: 10px; left: 10px; z-index: 1000; }
  #loginScreen {
    position: fixed; top:0; left:0; width:100%; height:100%; 
    background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center;
    z-index:2000;
  }
  #loginBox {
    background:white; padding:20px; border-radius:8px; width:300px; text-align:center;
  }
  #loginBox img { width: 120px; margin-bottom: 15px; }

  /* Panel derecho de atenciones */
  #panelAtenciones {
  position: absolute;
  right: 0;
  top: 0;
  width: 350px;
  height: 100%;
  background: #ffffff;
  border-left: 2px solid #ddd;
  overflow-y: auto;
  padding: 15px;
  z-index: 1500;

  /* animación */
  transform: translateX(100%);
  transition: transform 0.4s ease-in-out;
}

/* Cuando está visible */
#panelAtenciones.visible {
  transform: translateX(0);
}
</style>
</head>
<body>
<div id="loginScreen">
  <div id="loginBox">
    <img src="https://dl.dropboxusercontent.com/scl/fi/ymb0if0252ui58cy1voe2/logo-pluz.jpg?rlkey=ghj6tdtn6ccldppjyhj4a2zve&st=rnllbm7y" alt="Logo Pluz">
    <h4 class="mb-3">🔐 Iniciar sesión</h4>
    <div class="mb-2"><input type="text" id="user" class="form-control" placeholder="Usuario"></div>
    <div class="mb-2"><input type="password" id="pass" class="form-control" placeholder="Contraseña"></div>
    <button class="btn btn-primary w-100" onclick="login()">Ingresar</button>
    <div id="loginMsg" class="text-danger mt-2"></div>
  </div>
</div>

<button class="btn btn-primary toggle-btn" onclick="toggleSidebar()">☰</button>

<div id="sidebar">
  <h4>🔎 Buscar suministro</h4>
  <div class="input-group mb-2">
    <input type="text" id="searchBox" class="form-control" placeholder="Número de cliente">
    <button class="btn btn-success" onclick="buscarSuministro()">Buscar</button>
  </div>
  <div id="resultado" class="text-success mb-2"></div>
  <button id="verEnGoogle" class="btn btn-outline-primary btn-sm mb-3" style="display:none" onclick="abrirEnGoogleMaps()">Ver en Google Maps</button>
  
  <div id="progresoBox">
    <h6>📂 Progreso de carga:</h6>
    <div class="progress mb-2">
      <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
    </div>
    <ul id="progreso" class="list-group small mb-3"></ul>
  </div>

  <h6>📍 Suministros cercanos (&lt;20m):</h6>
  <ul id="cercanos" class="list-group small mb-3"></ul>

  <h6>🕑 Historial (últimos 3):</h6>
  <ul id="historial" class="list-group small mb-3"></ul>

  <h4>📡 Buscar SED</h4>
  <div class="input-group mb-2">
    <input type="text" id="searchSED" class="form-control" placeholder="Nombre de SED">
    <button class="btn btn-warning" onclick="buscarSED()">Buscar</button>
  </div>
  <div id="resultadoSED" class="text-primary mb-2"></div>
  <button id="verEnGoogleSED" class="btn btn-outline-warning btn-sm mb-3" style="display:none" onclick="abrirEnGoogleMapsSED()">Ver en Google Maps</button>

  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" id="toggleSEDs" onchange="toggleSEDs(this.checked)">
    <label class="form-check-label" for="toggleSEDs">Mostrar SEDs</label>
  </div>

  <h6>🔎 Suministros cercanos al SED (&lt;20m):</h6>
  <ul id="cercanosSED" class="list-group small mb-3"></ul>

  <h4>📍 Buscar por coordenadas</h4>
  <div class="input-group mb-2">
    <input type="text" id="coordInput" class="form-control" placeholder="Ej: -11.872993, -77.114656">
    <button class="btn btn-info" onclick="buscarPorCoordenadas()">Buscar</button>
  </div>
  <div id="resultadoCoord" class="text-primary small mb-2"></div>
  <h6>🔎 Suministros cercanos (&lt;20m):</h6>
  <ul id="cercanosCoord" class="list-group small mb-3"></ul>
</div>

<!-- Panel lateral derecho -->
<div id="panelAtenciones">
  <h5>📋 Atenciones del suministro</h5>
  <ul id="listaAtenciones" class="list-group"></ul>
</div>

<button class="btn btn-secondary" id="toggleAtencionesBtn" 
        style="position:absolute; bottom:20px; right:20px; z-index:1600;">
  📋 Atenciones
</button>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let datos = [], sedDatos = [], historial = [], cercanosMarkers = [], atenciones = [];
let ultimoEncontro = null, ultimaSED = null, map, marker;
let sedLayer = L.layerGroup();
let cargados = 0, datosListos = false;

// Inicializa mapa
map = L.map('map').setView([-11.95, -76.95], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Map data © OpenStreetMap contributors'
}).addTo(map);

const usuarios = [{user:"despachobt", pass:"Pluz2025"}];
function login(){
  const u=user.value.trim(), p=pass.value.trim();
  const ok=usuarios.find(x=>x.user===u&&x.pass===p);
  loginMsg.textContent = ok ? "" : "❌ Usuario o contraseña incorrectos";
  if(ok) loginScreen.style.display="none";
}

const urls = [
  {nombre:"NORTE CHICO",url:"https://dl.dropboxusercontent.com/scl/fi/gq78aaeeowpllmk6aq6u8/NORTE-CHICO.csv?rlkey=amoh5m764nbkoobv8tggbbmhb"},
  {nombre:"COLONIAL",url:"https://dl.dropboxusercontent.com/scl/fi/mo1wrl48ky5v74l3ybfpd/COLONIAL.csv?rlkey=jhcfg302k4re8lnp5aya8o02n"},
  {nombre:"PANAMERICANA",url:"https://dl.dropboxusercontent.com/scl/fi/qpt0c6dqyhututunxgby5/PANAMERICANA.csv?rlkey=gtkcg709xhcohqdu70v8fzo16"}
];

function actualizarProgreso(){
  cargados++;
  const bar=document.getElementById("progress-bar");
  const porcentaje=Math.round((cargados/urls.length)*100);
  bar.style.width=porcentaje+"%";
  bar.textContent=porcentaje+"%";
  if(cargados===urls.length){
    datosListos=true;
    bar.classList.remove("progress-bar-animated");
    const li=document.createElement("li");
    li.className="list-group-item text-success";
    li.textContent="✅ Todos los archivos cargados con éxito.";
    progreso.appendChild(li);
    setTimeout(()=>{progresoBox.style.display="none";},2000);
  }
}

// Cargar suministros
urls.forEach(f=>{
  fetch(f.url).then(r=>r.text()).then(texto=>{
    const lineas=texto.split("\n");
    lineas.slice(1).forEach(l=>{
      const cols=l.trim().split(";");
      if(cols.length>=4){
        datos.push({
          cliente:cols[0].trim(),
          ut:cols[1].trim(),
          lat:parseFloat(cols[2].replace(",", ".")),
          lon:parseFloat(cols[3].replace(",", "."))
        });
      }
    });
    actualizarProgreso();
    const li=document.createElement("li");
    li.className="list-group-item";
    li.textContent=`${f.nombre}: ${lineas.length} filas cargadas`;
    progreso.appendChild(li);
  }).catch(()=>{
    const li=document.createElement("li");
    li.className="list-group-item text-danger";
    li.textContent="❌ Error al cargar "+f.nombre;
    progreso.appendChild(li);
  });
});

// Cargar SEDs (inicialmente ocultas)
fetch("https://dl.dropboxusercontent.com/scl/fi/f27szlfjhlid5luse9j7y/SED.csv?rlkey=kmmfa1sawvl73b2wcdn2exrg4")
  .then(r=>r.text())
  .then(texto=>{
    const lineas=texto.trim().split(/\r?\n/);
    lineas.slice(1).forEach(l=>{
      const cols=l.split(",");
      if(cols.length>=7){
        const obj={
          sed:cols[0].trim().toUpperCase(),
          alim:cols[1].trim(),
          clientesBT:cols[2].trim(),
          tipo:cols[3].trim(),
          ut:cols[4].trim(),
          lon:parseFloat(cols[5].replace(",", ".").trim()),
          lat:parseFloat(cols[6].replace(",", ".").trim())
        };
        sedDatos.push(obj);
        const mark=L.rectangle([[obj.lat-0.00005,obj.lon-0.00005],[obj.lat+0.00005,obj.lon+0.00005]],{
          color:"blue",weight:1,fillOpacity:0.6
        }).bindTooltip(`SED: ${obj.sed}<br>ALIM: ${obj.alim}<br>UT: ${obj.ut}`);
        sedLayer.addLayer(mark);
      }
    });
  });

function toggleSEDs(show){
  if(show){ map.addLayer(sedLayer); }
  else { map.removeLayer(sedLayer); }
}

// --- CARGAR ATENCIONES DE 2024 Y 2025 ---
const urlsAtenciones = [
  "https://dl.dropboxusercontent.com/scl/fi/apuj5aek1sd4l8ytyeszx/ATENCIONDEF.csv?rlkey=4xc7p2stptclbku4bdwlxft8l&st=601n3suv", // 2025
  "https://dl.dropboxusercontent.com/scl/fi/fjtukk004juggluv64m4j/ATENCION2024.csv?rlkey=v3a8g97dyleyi21f57xz8jgzl&st=vtfp9g5r" // 2024
];

Promise.all(urlsAtenciones.map(url => fetch(url).then(r => r.text())))
  .then(respuestas => {
    respuestas.forEach((texto, idx) => {
      const lineas = texto.trim().split(/\r?\n/);
      lineas.slice(1).forEach(l => {
        const cols = l.split(";");
        if (cols.length >= 8) {
          const ticket = cols[0].replace(/"/g, "").trim();
          const tipoTrabajo = cols[1].replace(/"/g, "").trim();
          const tipo = cols[2].replace(/"/g, "").trim();
          const fecha = cols[3].replace(/"/g, "").trim();
          const alim = cols[4].replace(/"/g, "").trim();
          const sed = cols[5].replace(/"/g, "").trim();
          const cliente = cols[7].replace(/"/g, "").trim();
          if (cliente) {
            atenciones.push({
              ticket,
              tipo: `${tipoTrabajo} - ${tipo}`,
              fecha,
              alim,
              sed,
              cliente,
              fuente: idx === 0 ? "2025" : "2024"
            });
          }
        }
      });
    });
    console.log("✅ Archivos de atenciones combinados:", atenciones.length, "registros totales");
  })
  .catch(err => console.error("❌ Error al cargar archivos de atenciones:", err));

// --- FUNCIONES ---
function buscarSuministro(){
  if(!datosListos){ resultado.textContent="⚠️ Espera a que termine la carga."; return; }
  const num=searchBox.value.trim();
  const encontrado=datos.find(d=>d.cliente===num);
  if(encontrado){
    ultimoEncontro=encontrado;
    resultado.textContent="✅ Encontrado en "+encontrado.ut;
    verEnGoogle.style.display="inline";
    actualizarMapa(encontrado.lat,encontrado.lon,encontrado);
    mostrarAtenciones(encontrado.cliente);
  } else {
    resultado.textContent="❌ Suministro no encontrado";
    verEnGoogle.style.display="none";
  }
}

function mostrarAtenciones(clienteID){
  const lista=document.getElementById("listaAtenciones");
  const panel=document.getElementById("panelAtenciones");
  lista.innerHTML="";
  panel.style.display="block";

  const idLimpio=clienteID.trim().replace(/"/g,"");
  const misAtenciones=atenciones.filter(a=>a.cliente===idLimpio);

  if(misAtenciones.length===0){
    lista.innerHTML=`<li class="list-group-item text-muted">Sin atenciones registradas para ${idLimpio}</li>`;
    return;
  }

misAtenciones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(a => {
  const li = document.createElement("li");
  li.className = "list-group-item mb-2";

  // --- 🔹 Formatear fecha como dd/mm/aaaa ---
  let fechaFormateada = a.fecha;
  const fechaObj = new Date(a.fecha);
  if (!isNaN(fechaObj)) {
    const dia = String(fechaObj.getDate()).padStart(2, "0");
    const mes = String(fechaObj.getMonth() + 1).padStart(2, "0");
    const anio = fechaObj.getFullYear();
    fechaFormateada = `${dia}/${mes}/${anio}`;
  }

  li.innerHTML = `
    🧾 <b>${a.ticket}</b><br>
    🛠️ <b>Tipo:</b> ${a.tipo}<br>
    📅 <b>Fecha:</b> ${fechaFormateada}<br>
    ⚡ <b>Alim:</b> ${a.alim}<br>
    🏷️ <b>SED:</b> ${a.sed}
  `;
  lista.appendChild(li);
});
}

// Actualizar mapa / marcador principal
function actualizarMapa(lat,lon,encontrado){
  if(marker) map.removeLayer(marker);
  marker=L.marker([lat,lon],{title:"Cliente "+(encontrado.cliente||"")}).addTo(map);
  marker.bindTooltip(`Cliente: ${encontrado.cliente}<br>UT: ${encontrado.ut}`).openTooltip();
  map.setView([lat,lon],17,{animate:true});
}

// Abrir en Google Maps
function abrirEnGoogleMaps(){ if(ultimoEncontro){ window.open(`https://www.google.com/maps/search/?api=1&query=${ultimoEncontro.lat},${ultimoEncontro.lon}`,'_blank'); }}
function abrirEnGoogleMapsSED(){ if(ultimaSED){ window.open(`https://www.google.com/maps/search/?api=1&query=${ultimaSED.lat},${ultimaSED.lon}`,'_blank'); }}
function toggleSidebar(){ sidebar.classList.toggle("hidden"); }
</script>
<script>
// --- FUNCION AUXILIAR: calcular distancia (en metros aprox) ---
function distancia(lat1, lon1, lat2, lon2) {
  const R = 6371000; // radio tierra en metros
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// --- FUNCION GENERAL PARA BUSCAR CERCANOS ---
function obtenerCercanos(lat, lon, max = 4, limite = 20) {
  const distancias = datos.map(d => ({
    ...d,
    dist: distancia(lat, lon, d.lat, d.lon)
  }));
  distancias.sort((a, b) => a.dist - b.dist);
  return distancias.filter(d => d.dist < limite).slice(0, max);
}

// --- Limpiar markers cercanos previos ---
function limpiarCercanos() {
  cercanosMarkers.forEach(m => map.removeLayer(m));
  cercanosMarkers = [];
}

// --- BUSCAR SUMINISTRO ---
function buscarSuministro() {
  if (!datosListos) { resultado.textContent="⚠️ Espera a que termine la carga."; return; }
  const num = searchBox.value.trim();
  const encontrado = datos.find(d => d.cliente === num);
  const lista = document.getElementById("cercanos");
  lista.innerHTML = "";
  limpiarCercanos();

  if (encontrado) {
    ultimoEncontro = encontrado;
    resultado.textContent = "✅ Encontrado en " + encontrado.ut;
    verEnGoogle.style.display = "inline";
    actualizarMapa(encontrado.lat, encontrado.lon, encontrado);
    mostrarAtenciones(encontrado.cliente);

    // mostrar cercanos
    const cercanos = obtenerCercanos(encontrado.lat, encontrado.lon);
    cercanos.forEach(c => {
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = `${c.cliente} (${c.dist.toFixed(1)}m)`;
      lista.appendChild(li);

      // marcador en el mapa
      const m = L.circleMarker([c.lat, c.lon], {radius:6, color:"red"}).addTo(map);
      m.bindTooltip(`Cliente: ${c.cliente}<br>Distancia: ${c.dist.toFixed(1)}m`);
      cercanosMarkers.push(m);
    });
  } else {
    resultado.textContent = "❌ Suministro no encontrado";
    verEnGoogle.style.display = "none";
  }
}

// --- BUSCAR SED ---
function buscarSED() {
  const nombre = searchSED.value.trim().toUpperCase();
  const encontrado = sedDatos.find(s => s.sed === nombre);
  const lista = document.getElementById("cercanosSED");
  lista.innerHTML = "";
  limpiarCercanos();
  if(marker) map.removeLayer(marker);

  if (encontrado) {
    ultimaSED = encontrado;
    resultadoSED.textContent = "✅ Encontrado SED " + encontrado.sed;
    verEnGoogleSED.style.display = "inline";
    marker = L.marker([encontrado.lat, encontrado.lon],{title:"SED "+encontrado.sed}).addTo(map);
    marker.bindTooltip(`SED: ${encontrado.sed}<br>UT: ${encontrado.ut}`).openTooltip();
    map.setView([encontrado.lat, encontrado.lon], 17);

    // mostrar cercanos a la SED
    const cercanos = obtenerCercanos(encontrado.lat, encontrado.lon);
    cercanos.forEach(c => {
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = `${c.cliente} (${c.dist.toFixed(1)}m)`;
      lista.appendChild(li);

      const m = L.circleMarker([c.lat, c.lon], {radius:6, color:"red"}).addTo(map);
      m.bindTooltip(`Cliente: ${c.cliente}<br>Distancia: ${c.dist.toFixed(1)}m`);
      cercanosMarkers.push(m);
    });
  } else {
    resultadoSED.textContent = "❌ SED no encontrada";
    verEnGoogleSED.style.display = "none";
  }
}

// --- BUSCAR POR COORDENADAS ---
function buscarPorCoordenadas() {
  const valor = coordInput.value.trim();
  const partes = valor.split(",");
  const lista = document.getElementById("cercanosCoord");
  lista.innerHTML = "";
  limpiarCercanos();
  if(marker) map.removeLayer(marker);

  if (partes.length === 2) {
    const lat = parseFloat(partes[0]);
    const lon = parseFloat(partes[1]);
    if (!isNaN(lat) && !isNaN(lon)) {
      resultadoCoord.textContent = "✅ Coordenadas válidas";
      marker = L.marker([lat, lon],{title:"Ubicación"}).addTo(map);
      map.setView([lat, lon], 17);

      const cercanos = obtenerCercanos(lat, lon);
      cercanos.forEach(c => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = `${c.cliente} (${c.dist.toFixed(1)}m)`;
        lista.appendChild(li);

        const m = L.circleMarker([c.lat, c.lon], {radius:6, color:"red"}).addTo(map);
        m.bindTooltip(`Cliente: ${c.cliente}<br>Distancia: ${c.dist.toFixed(1)}m`);
        cercanosMarkers.push(m);
      });
      return;
    }
  }
  resultadoCoord.textContent = "❌ Coordenadas inválidas";
}
// --- TOGGLE PANEL ATENCIONES ---
const btnAtenciones = document.getElementById("toggleAtencionesBtn");
const panelAtenciones = document.getElementById("panelAtenciones");

btnAtenciones.addEventListener("click", () => {
  panelAtenciones.classList.toggle("visible");

  if (panelAtenciones.classList.contains("visible")) {
    btnAtenciones.textContent = "❌ Cerrar";
    btnAtenciones.classList.remove("btn-secondary");
    btnAtenciones.classList.add("btn-danger");
  } else {
    btnAtenciones.textContent = "📋 Atenciones";
    btnAtenciones.classList.remove("btn-danger");
    btnAtenciones.classList.add("btn-secondary");
  }
});
</script>
</body>
</html>
