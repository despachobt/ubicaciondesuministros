<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Buscador de Suministros</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
	#panelAtenciones.hidden {
  	display: none !important;
	}
  body { margin: 0; height: 100vh; display: flex; overflow: hidden; }
  #sidebar { width: 320px; background: #f8f9fa; padding: 15px; overflow-y: auto; transition: all 0.3s ease; }
  #sidebar.hidden { transform: translateX(-100%); }
  #map { flex: 1; }
  .fade-in { animation: fadeIn 0.5s ease-in-out; }
  @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
  .toggle-btn { position: absolute; top: 10px; left: 10px; z-index: 1000; }
  #loginScreen {
    position: fixed; top:0; left:0; width:100%; height:100%; 
    background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center;
    z-index:2000;
  }
  #loginBox {
    background:white; padding:20px; border-radius:8px; width:300px; text-align:center;
  }
  #loginBox img { width: 120px; margin-bottom: 15px; }

  /* Panel derecho de atenciones */
  #panelAtenciones {
  position: absolute;
  right: 0;
  top: 0;
  width: 350px;
  height: 100%;
  background: #ffffff;
  border-left: 2px solid #ddd;
  overflow-y: auto;
  padding: 15px;
  z-index: 1500;

  /* animaciÃ³n */
  transform: translateX(100%);
  transition: transform 0.4s ease-in-out;
}

/* Cuando estÃ¡ visible */
#panelAtenciones.visible {
  transform: translateX(0);
}
.sed-label {
  font-size: 12px;
  color: #0d6efd; /* azul */
  font-weight: 600;
  text-shadow: 1px 1px 2px white;
  pointer-events: none; /* evita bloquear clics */
  text-align: center;
}
input[type=range] {
  accent-color: #0d6efd; /* azul bootstrap */
}
</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<div id="loginScreen">
  <div id="loginBox">
    <img src="https://dl.dropboxusercontent.com/scl/fi/a2xxg9id8bd8thsgct4bd/PLUZ-NAVIDAD.jpg?rlkey=mn9r5p4yosr6oe30lr03xhuk1" alt="Logo Pluz">
    <h4 class="mb-3">ğŸ” Iniciar sesiÃ³n</h4>
    <div class="mb-2"><input type="text" id="user" class="form-control" placeholder="Usuario"></div>
    <div class="mb-2"><input type="password" id="pass" class="form-control" placeholder="ContraseÃ±a"></div>
    <button class="btn btn-primary w-100" onclick="login()">Ingresar</button>
    <div id="loginMsg" class="text-danger mt-2"></div>
  </div>
</div>

<button class="btn btn-primary toggle-btn" onclick="toggleSidebar()">â˜°</button>

<div id="sidebar">
  <h4>ğŸ§­ Buscador general</h4>
<div id="progresoBox" class="mb-3">
  <div class="progress">
    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
         role="progressbar" style="width: 0%">0%</div>
  </div>
  <ul id="progreso" class="list-group small mt-2"></ul>
</div>
  <!-- Selector de modo -->
  <div class="mb-3">
    <label for="modoBusqueda" class="form-label">Selecciona tipo de bÃºsqueda:</label>
    <select id="modoBusqueda" class="form-select" onchange="cambiarModoBusqueda()">
      <option value="suministro" selected>ğŸ” Suministro</option>
      <option value="sed">ğŸ“¡ SED</option>
      <option value="coordenadas">ğŸ“ Coordenadas</option>
    </select>
  </div>

  <!-- Controles generales -->
  <div class="mb-3">
    <label for="radioInput" class="form-label">
  ğŸ¯ Radio de bÃºsqueda: <b><span id="radioLabel">20</span> m</b>
</label>

<input type="range" id="radioInput"
       class="form-range"
       min="5" max="200" step="5" value="20">
  </div>

  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" id="toggleSEDs" onchange="toggleSEDs(this.checked)">
    <label class="form-check-label" for="toggleSEDs">Mostrar todas las SEDs</label>
  </div>

  <!-- ğŸ”¹ BLOQUE SUMINISTRO -->
  <div id="bloqueSuministro">
    <h5>ğŸ” Buscar suministro</h5>
    <div class="input-group mb-2">
      <input type="text" id="searchBox" class="form-control" placeholder="NÃºmero de cliente">
      <button class="btn btn-success" onclick="buscarSuministro()">Buscar</button>
    </div>
    <div id="resultado" class="text-success mb-2"></div>
    <button id="verEnGoogle" class="btn btn-outline-primary btn-sm mb-3" style="display:none" onclick="abrirEnGoogleMaps()">Ver en Google Maps</button>
    <h6>ğŸ“ Suministros cercanos:</h6>
    <ul id="cercanos" class="list-group small mb-3"></ul>
  </div>

  <!-- ğŸ”¹ BLOQUE SED -->
  <div id="bloqueSED" style="display:none;">
    <h5>ğŸ“¡ Buscar SED</h5>
    <div class="input-group mb-2">
      <input type="text" id="searchSED" class="form-control" placeholder="Nombre de SED">
      <button class="btn btn-warning" onclick="buscarSED()">Buscar</button>
    </div>
    <div id="resultadoSED" class="text-primary mb-2"></div>
    <button id="verEnGoogleSED" class="btn btn-outline-warning btn-sm mb-3" style="display:none" onclick="abrirEnGoogleMapsSED()">Ver en Google Maps</button>
    <h6>ğŸ“ Suministros cercanos:</h6>
    <ul id="cercanosSED" class="list-group small mb-3"></ul>
  </div>

  <!-- ğŸ”¹ BLOQUE COORDENADAS -->
  <div id="bloqueCoord" style="display:none;">
    <h5>ğŸ“ Buscar por coordenadas</h5>
    <div class="input-group mb-2">
      <input type="text" id="coordInput" class="form-control" placeholder="Ej: -11.872993, -77.114656">
      <button class="btn btn-info" onclick="buscarPorCoordenadas()">Buscar</button>
    </div>
    <div id="resultadoCoord" class="text-primary small mb-2"></div>
    <h6>ğŸ“ Suministros cercanos:</h6>
    <ul id="cercanosCoord" class="list-group small mb-3"></ul>
  </div>

  <!-- Historial -->
  <h6> </h6>
  <ul id="historial" class="list-group small mb-3"></ul>
</div>

<button class="btn btn-secondary" id="toggleAtencionesBtn" 
        style="position:absolute; bottom:20px; right:20px; z-index:1600;">
  ğŸ“‹ Atenciones
</button>
<div id="panelAtenciones">
  <h5>ğŸ“‹ Atenciones del suministro</h5>
<button class="btn btn-success btn-sm mb-3 w-100"
        onclick="exportarAtencionesExcel()">
  ğŸ“¥ Exportar a Excel
</button>
  <ul id="listaAtenciones" class="list-group"></ul>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let datos = [], sedDatos = [], historial = [], cercanosMarkers = [], atenciones = [];
let ultimoEncontro = null, ultimaSED = null, map, marker;
let sedLayer = L.layerGroup();
let cargados = 0, datosListos = false;
let clienteActualAtenciones = null;

// Inicializa mapa
map = L.map('map').setView([-11.95, -76.95], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Map data Â© OpenStreetMap contributors'
}).addTo(map);

const usuarios = [{user:"despachobt", pass:"Pluz2025"}];
function login(){
  const u=user.value.trim(), p=pass.value.trim();
  const ok=usuarios.find(x=>x.user===u&&x.pass===p);
  loginMsg.textContent = ok ? "" : "âŒ Usuario o contraseÃ±a incorrectos";
  if(ok) loginScreen.style.display="none";
}

const urls = [
  {nombre:"NORTE CHICO",url:"https://dl.dropboxusercontent.com/scl/fi/gq78aaeeowpllmk6aq6u8/NORTE-CHICO.csv?rlkey=amoh5m764nbkoobv8tggbbmhb"},
  {nombre:"COLONIAL",url:"https://dl.dropboxusercontent.com/scl/fi/mo1wrl48ky5v74l3ybfpd/COLONIAL.csv?rlkey=jhcfg302k4re8lnp5aya8o02n"},
  {nombre:"PANAMERICANA",url:"https://dl.dropboxusercontent.com/scl/fi/qpt0c6dqyhututunxgby5/PANAMERICANA.csv?rlkey=gtkcg709xhcohqdu70v8fzo16"}
];

function actualizarProgreso(){
  cargados++;
  const bar=document.getElementById("progress-bar");
  const porcentaje=Math.round((cargados/urls.length)*100);
  bar.style.width=porcentaje+"%";
  bar.textContent=porcentaje+"%";
  if(cargados===urls.length){
    datosListos=true;
    bar.classList.remove("progress-bar-animated");
    const li=document.createElement("li");
    li.className="list-group-item text-success";
    li.textContent="âœ… Todos los archivos cargados con Ã©xito.";
    progreso.appendChild(li);
    setTimeout(()=>{progresoBox.style.display="none";},2000);
  }
}

// Cargar suministros
urls.forEach(f=>{
  fetch(f.url).then(r=>r.text()).then(texto=>{
    const lineas=texto.split("\n");
    lineas.slice(1).forEach(l=>{
      const cols=l.trim().split(";");
      if(cols.length>=4){
        datos.push({
          cliente:cols[0].trim(),
          ut:cols[1].trim(),
          lat:parseFloat(cols[2].replace(",", ".")),
          lon:parseFloat(cols[3].replace(",", "."))
        });
      }
    });
    actualizarProgreso();
    const li=document.createElement("li");
    li.className="list-group-item";
    li.textContent=`${f.nombre}: ${lineas.length} filas cargadas`;
    progreso.appendChild(li);
  }).catch(()=>{
    const li=document.createElement("li");
    li.className="list-group-item text-danger";
    li.textContent="âŒ Error al cargar "+f.nombre;
    progreso.appendChild(li);
  });
});

// Cargar SEDs (inicialmente ocultas)
fetch("https://dl.dropboxusercontent.com/scl/fi/f27szlfjhlid5luse9j7y/SED.csv?rlkey=kmmfa1sawvl73b2wcdn2exrg4")
  .then(r=>r.text())
  .then(texto=>{
    const lineas=texto.trim().split(/\r?\n/);
    lineas.slice(1).forEach(l=>{
      const cols=l.split(",");
      if(cols.length>=7){
        const obj={
          sed:cols[0].trim().toUpperCase(),
          alim:cols[1].trim(),
          clientesBT:cols[2].trim(),
          tipo:cols[3].trim(),
          ut:cols[4].trim(),
          lon:parseFloat(cols[5].replace(",", ".").trim()),
          lat:parseFloat(cols[6].replace(",", ".").trim())
        };
        sedDatos.push(obj);
       // ğŸ”¹ Crear el rectÃ¡ngulo azul de la SED
const mark = L.rectangle(
  [[obj.lat - 0.00005, obj.lon - 0.00005], [obj.lat + 0.00005, obj.lon + 0.00005]],
  { color: "blue", weight: 1, fillOpacity: 0.6 }
).bindTooltip(`SED: ${obj.sed}<br>ALIM: ${obj.alim}<br>UT: ${obj.ut}`);
sedLayer.addLayer(mark);

// ğŸ”¹ Agregar etiqueta fija debajo de la SED
const labelIcon = L.divIcon({
  className: "sed-label",
  html: `<div>${obj.sed}</div>`,
  iconSize: [80, 20],
  iconAnchor: [40, -10] // ajusta altura bajo el rectÃ¡ngulo
});
const labelMarker = L.marker([obj.lat, obj.lon], { icon: labelIcon, interactive: false });
sedLayer.addLayer(labelMarker);
      }
    });
  });

function toggleSEDs(show){
  if(show){ map.addLayer(sedLayer); }
  else { map.removeLayer(sedLayer); }
}

// --- CARGAR ATENCIONES DE 2024 Y 2025 ---
const urlsAtenciones = [
  "https://dl.dropboxusercontent.com/scl/fi/wmk8o9eexfkatckqghzp9/ATENCIONDEF.csv?rlkey=9d3y1vv1laf4e5upznta16b3s", // 2025
  "https://dl.dropboxusercontent.com/scl/fi/fjtukk004juggluv64m4j/ATENCION2024.csv?rlkey=v3a8g97dyleyi21f57xz8jgzl&st=vtfp9g5r" // 2024
];

Promise.all(urlsAtenciones.map(url => fetch(url).then(r => r.text())))
  .then(respuestas => {
    respuestas.forEach((texto, idx) => {
      const lineas = texto.trim().split(/\r?\n/);
      lineas.slice(1).forEach(l => {
        const cols = l.split(";");
        if (cols.length >= 8) {
          const ticket = cols[0].replace(/"/g, "").trim();
          const tipoTrabajo = cols[1].replace(/"/g, "").trim();
          const tipo = cols[2].replace(/"/g, "").trim();
          const fecha = cols[3].replace(/"/g, "").trim();
          const alim = cols[4].replace(/"/g, "").trim();
          const sed = cols[5].replace(/"/g, "").trim();
          const cliente = cols[7].replace(/"/g, "").trim();
          if (cliente) {
            atenciones.push({
              ticket,
              tipo: `${tipoTrabajo} - ${tipo}`,
              fecha,
              alim,
              sed,
              cliente,
              fuente: idx === 0 ? "2025" : "2024"
            });
          }
        }
      });
    });
    console.log("âœ… Archivos de atenciones combinados:", atenciones.length, "registros totales");
  })
  .catch(err => console.error("âŒ Error al cargar archivos de atenciones:", err));

// ============================
// ğŸ”¹ CARGAR CLIENTES CADE1 Y CADE2
// ============================
let mapaClientes = {};

Promise.all([
  fetch("https://dl.dropboxusercontent.com/scl/fi/xmyi6f2rq043o5wppqaav/CLIENTES-CADE1.csv?rlkey=fd3etny0fp9no9083wt7w6lmb&st=1wzt8eo6").then(r => r.text()),
  fetch("https://dl.dropboxusercontent.com/scl/fi/mdgj2b4eb82sibsc1vehk/CLIENTES-CADE2.csv?rlkey=oacn2n4qgqte8wv3cluqmyi8k&st=nb6tpxnk").then(r => r.text())
])
.then(([cade1Text, cade2Text]) => {
  const parseCSV = (txt) =>
    txt
      .trim()
      .split(/\r?\n/)
      .slice(1)
      .map(l => {
        const cols = l.split(",");
        return {
          CLIENTE: cols[0]?.trim().replace(/"/g, ""),
          ALIMCD: cols[1]?.trim().replace(/"/g, "")
        };
      })
      .filter(c => c.CLIENTE);

  const cade1 = parseCSV(cade1Text);
  const cade2 = parseCSV(cade2Text);
  const todos = [...cade1, ...cade2];

  todos.forEach(c => {
    mapaClientes[c.CLIENTE] = c.ALIMCD || "No disponible";
  });

  console.log("âœ… CLIENTES-CADE cargados correctamente:", Object.keys(mapaClientes).length);
})
.catch(err => console.error("âŒ Error al cargar CLIENTES-CADE:", err));

// --- FUNCIONES ---
function mostrarAtenciones(clienteID){
  const lista=document.getElementById("listaAtenciones");
  const panel=document.getElementById("panelAtenciones");
  lista.innerHTML="";
  panel.style.display="block";

  const idLimpio = clienteID.trim().replace(/"/g,"");

  // ğŸ”¹ GUARDAR CLIENTE ACTUAL
  clienteActualAtenciones = idLimpio;

  const misAtenciones = atenciones.filter(a => a.cliente === idLimpio);

  if(misAtenciones.length===0){
    lista.innerHTML=`<li class="list-group-item text-muted">Sin atenciones registradas para ${idLimpio}</li>`;
    return;
  }

misAtenciones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(a => {
  const li = document.createElement("li");
  li.className = "list-group-item mb-2";

  // --- ğŸ”¹ Formatear fecha como dd/mm/aaaa ---
  let fechaFormateada = a.fecha;
  const fechaObj = new Date(a.fecha);
  if (!isNaN(fechaObj)) {
    const dia = String(fechaObj.getDate()).padStart(2, "0");
    const mes = String(fechaObj.getMonth() + 1).padStart(2, "0");
    const anio = fechaObj.getFullYear();
    fechaFormateada = `${dia}/${mes}/${anio}`;
  }

  li.innerHTML = `
    ğŸ§¾ <b>${a.ticket}</b><br>
    ğŸ› ï¸ <b>Tipo:</b> ${a.tipo}<br>
    ğŸ“… <b>Fecha:</b> ${fechaFormateada}<br>
    âš¡ <b>Alim:</b> ${a.alim}<br>
    ğŸ·ï¸ <b>SED:</b> ${a.sed}
  `;
  lista.appendChild(li);
});
}

// Actualizar mapa / marcador principal
function actualizarMapa(lat,lon,encontrado){
  if(marker) map.removeLayer(marker);
  marker=L.marker([lat,lon],{title:"Cliente "+(encontrado.cliente||"")}).addTo(map);
  marker.bindTooltip(`Cliente: ${encontrado.cliente}<br>UT: ${encontrado.ut}`).openTooltip();
  map.setView([lat,lon],17,{animate:true});
}

// Abrir en Google Maps
function abrirEnGoogleMaps(){ if(ultimoEncontro){ window.open(`https://www.google.com/maps/search/?api=1&query=${ultimoEncontro.lat},${ultimoEncontro.lon}`,'_blank'); }}
function abrirEnGoogleMapsSED(){ if(ultimaSED){ window.open(`https://www.google.com/maps/search/?api=1&query=${ultimaSED.lat},${ultimaSED.lon}`,'_blank'); }}
function toggleSidebar(){ sidebar.classList.toggle("hidden"); }
</script>
<script>
// --- FUNCION AUXILIAR: calcular distancia (en metros aprox) ---
function distancia(lat1, lon1, lat2, lon2) {
  const R = 6371000; // radio tierra en metros
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// --- FUNCION GENERAL PARA BUSCAR CERCANOS ---
function obtenerCercanos(lat, lon, max = 5) {
  const limite = parseFloat(document.getElementById("radioInput").value) || 20;
  const distancias = datos.map(d => ({
    ...d,
    dist: distancia(lat, lon, d.lat, d.lon)
  }));
  distancias.sort((a, b) => a.dist - b.dist);
  return distancias.filter(d => d.dist < limite).slice(0, max);
}

// --- Limpiar markers cercanos previos ---
function limpiarCercanos() {
  cercanosMarkers.forEach(m => map.removeLayer(m));
  cercanosMarkers = [];
}

// --- BUSCAR SUMINISTRO ---
function buscarSuministro() {
  if (!datosListos) { resultado.textContent="âš ï¸ Espera a que termine la carga."; return; }
  const num = searchBox.value.trim();
  const encontrado = datos.find(d => d.cliente === num);
  const lista = document.getElementById("cercanos");
  lista.innerHTML = "";
  limpiarCercanos();

  if (encontrado) {
  ultimoEncontro = encontrado;
  const alimCd = mapaClientes[encontrado.cliente] || "No disponible";
  resultado.innerHTML = `âœ… Encontrado CLIENTE <b>${encontrado.cliente}</b><br>
                         ğŸ“¡ <b>${alimCd}<br>
                         ğŸ—‚ï¸ ${encontrado.ut}`;

    verEnGoogle.style.display = "inline";
    actualizarMapa(encontrado.lat, encontrado.lon, encontrado);
    mostrarAtenciones(encontrado.cliente);

    // mostrar cercanos
    const cercanos = obtenerCercanos(encontrado.lat, encontrado.lon);
    cercanos.forEach(c => {
  const alimCdCercano = mapaClientes[c.cliente] || "No disponible";
  const li = document.createElement("li");
  li.className = "list-group-item";
  li.innerHTML = `
    <b>${c.cliente}</b><br>
    ğŸ“¡ <span class="text-primary">${alimCdCercano}</span><br>
    ğŸ“ ${c.dist.toFixed(1)} m
  `;
  lista.appendChild(li);

  // marcador en el mapa
  const m = L.circleMarker([c.lat, c.lon], { radius: 6, color: "red" }).addTo(map);
  m.bindTooltip(`
    Cliente: ${c.cliente}<br>
    ALIM CD: ${alimCdCercano}<br>
    Distancia: ${c.dist.toFixed(1)}m
  `);
  cercanosMarkers.push(m);
});
  } else {
    resultado.textContent = "âŒ Suministro no encontrado";
    verEnGoogle.style.display = "none";
  }
}

// --- BUSCAR SED ---
function buscarSED() {
  const nombre = searchSED.value.trim().toUpperCase();
  const encontrado = sedDatos.find(s => s.sed === nombre);
  const lista = document.getElementById("cercanosSED");
  lista.innerHTML = "";
  limpiarCercanos();
  if(marker) map.removeLayer(marker);

  if (encontrado) {
    ultimaSED = encontrado;

    // ğŸŸ¡ Mostrar resultado con alimentador al costado
    const alimTexto = encontrado.alim ? ` (${encontrado.alim})` : "";
    resultadoSED.innerHTML = `âœ… Encontrado SED <b>${encontrado.sed}</b>${alimTexto}`;
    verEnGoogleSED.style.display = "inline";

// --- BotÃ³n para ver detalle de SED ---
let btnDetalle = document.getElementById("btnDetalleSED");
if (!btnDetalle) {
  btnDetalle = document.createElement("button");
  btnDetalle.id = "btnDetalleSED";
  btnDetalle.className = "btn btn-outline-secondary btn-sm mb-3 ms-2";
  btnDetalle.textContent = "ğŸ” Detalle SED";
  btnDetalle.onclick = () => mostrarDetalleSED(encontrado.sed);
  resultadoSED.insertAdjacentElement("afterend", btnDetalle);
} else {
  btnDetalle.onclick = () => mostrarDetalleSED(encontrado.sed);
  btnDetalle.style.display = "inline";
}
    marker = L.marker([encontrado.lat, encontrado.lon],{title:"SED "+encontrado.sed}).addTo(map);
    marker.bindTooltip(`SED: ${encontrado.sed}<br>UT: ${encontrado.ut}`).openTooltip();
    map.setView([encontrado.lat, encontrado.lon], 17);

    // mostrar cercanos a la SED
    const cercanos = obtenerCercanos(encontrado.lat, encontrado.lon);
    cercanos.forEach(c => {
  const alimCdCercano = mapaClientes[c.cliente] || "No disponible";
  const li = document.createElement("li");
  li.className = "list-group-item";
  li.innerHTML = `
    <b>${c.cliente}</b><br>
    ğŸ“¡ <span class="text-primary">${alimCdCercano}</span><br>
    ğŸ“ ${c.dist.toFixed(1)} m
  `;
  lista.appendChild(li);

  // marcador en el mapa con tooltip
  const m = L.circleMarker([c.lat, c.lon], {
    radius: 6,
    color: "red",
    weight: 1.5,
    fillOpacity: 0.7
  }).addTo(map);

  m.bindTooltip(`
    <b>Cliente:</b> ${c.cliente}<br>
    <b>ALIM CD:</b> ${alimCdCercano}<br>
    <b>Distancia:</b> ${c.dist.toFixed(1)}m
  `);

  cercanosMarkers.push(m);
});
  } else {
    resultadoSED.textContent = "âŒ SED no encontrada";
    verEnGoogleSED.style.display = "none";
  }
}

// --- BUSCAR POR COORDENADAS ---
function buscarPorCoordenadas() {
  const valor = coordInput.value.trim();
  const partes = valor.split(",");
  const lista = document.getElementById("cercanosCoord");
  lista.innerHTML = "";
  limpiarCercanos();
  if(marker) map.removeLayer(marker);

  if (partes.length === 2) {
    const lat = parseFloat(partes[0]);
    const lon = parseFloat(partes[1]);
    if (!isNaN(lat) && !isNaN(lon)) {
      resultadoCoord.textContent = "âœ… Coordenadas vÃ¡lidas";
      marker = L.marker([lat, lon],{title:"UbicaciÃ³n"}).addTo(map);
      map.setView([lat, lon], 17);

      const cercanos = obtenerCercanos(lat, lon);
      cercanos.forEach(c => {
  const alimCdCercano = mapaClientes[c.cliente] || "No disponible";

  // ğŸ§¾ agregar a la lista
  const li = document.createElement("li");
  li.className = "list-group-item";
  li.innerHTML = `
    <b>${c.cliente}</b><br>
    ğŸ“¡ <span class="text-primary">${alimCdCercano}</span><br>
    ğŸ“ ${c.dist.toFixed(1)} m
  `;
  lista.appendChild(li);

  // ğŸ“ marcador con tooltip en el mapa
  const m = L.circleMarker([c.lat, c.lon], {
    radius: 6,
    color: "red",
    weight: 1.5,
    fillOpacity: 0.7
  }).addTo(map);

  m.bindTooltip(`
    <b>Cliente:</b> ${c.cliente}<br>
    <b>ALIM CD:</b> ${alimCdCercano}<br>
    <b>Distancia:</b> ${c.dist.toFixed(1)}m
  `);

  cercanosMarkers.push(m);
});
      return;
    }
  }
  resultadoCoord.textContent = "âŒ Coordenadas invÃ¡lidas";
}
// --- TOGGLE PANEL ATENCIONES ---
const btnAtenciones = document.getElementById("toggleAtencionesBtn");
const panelAtenciones = document.getElementById("panelAtenciones");

btnAtenciones.addEventListener("click", () => {
  panelAtenciones.classList.toggle("visible");

  if (panelAtenciones.classList.contains("visible")) {
    btnAtenciones.textContent = "âŒ Cerrar";
    btnAtenciones.classList.remove("btn-secondary");
    btnAtenciones.classList.add("btn-danger");
  } else {
    btnAtenciones.textContent = "ğŸ“‹ Atenciones";
    btnAtenciones.classList.remove("btn-danger");
    btnAtenciones.classList.add("btn-secondary");
  }
});

// ============================
// ğŸ”¹ CARGAR ARCHIVO SED_CLIENTES
// ============================
let sedClientes = [];

fetch("https://dl.dropboxusercontent.com/scl/fi/z8sr9bae1ds4myo7dmbni/SED_CLIENTES.csv?rlkey=3d7xy5746v3a3lpemiorp7sj0&st=bcf3izrn")
  .then(r => r.text())
  .then(texto => {
    const lineas = texto.trim().split(/\r?\n/);
    lineas.slice(1).forEach(l => {
      const cols = l.split(",");
      if (cols.length >= 3) {
        sedClientes.push({
          sed: cols[0].trim().toUpperCase(),
          llave: cols[1].trim(),
          clientes: parseInt(cols[2]) || 0
        });
      }
    });
    console.log("âœ… Archivo SED_CLIENTES cargado:", sedClientes.length, "registros");
  })
  .catch(err => console.error("âŒ Error al cargar SED_CLIENTES:", err));


// ============================
// ğŸ”¹ MOSTRAR DETALLE DE UNA SED
// ============================
function mostrarDetalleSED(nombreSED) {
  const modal = new bootstrap.Modal(document.getElementById("detalleSEDModal"));
  const tabla = document.getElementById("tablaDetalleSED");
  const titulo = document.getElementById("detalleSEDNombre");
  const totalDiv = document.getElementById("totalClientesSED");

  tabla.innerHTML = "";
  totalDiv.textContent = "";
  titulo.textContent = "SED: " + nombreSED;

  const registros = sedClientes.filter(s => s.sed === nombreSED);
  if (registros.length === 0) {
    tabla.innerHTML = `<tr><td colspan="2" class="text-muted">Sin informaciÃ³n disponible</td></tr>`;
    modal.show();
    return;
  }

  let total = 0;
  registros.forEach(r => {
    total += r.clientes;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.llave}</td><td>${r.clientes}</td>`;
    tabla.appendChild(tr);
  });

  totalDiv.textContent = `Total de clientes: ${total}`;
  modal.show();
}
// Actualizar etiqueta visual del radio
const radioInput = document.getElementById("radioInput");
const radioLabel = document.getElementById("radioLabel");

radioInput.addEventListener("input", () => {
  radioLabel.textContent = radioInput.value;
});
function cambiarModoBusqueda() {
  const modo = document.getElementById("modoBusqueda").value;
  document.getElementById("bloqueSuministro").style.display = (modo === "suministro") ? "block" : "none";
  document.getElementById("bloqueSED").style.display = (modo === "sed") ? "block" : "none";
  document.getElementById("bloqueCoord").style.display = (modo === "coordenadas") ? "block" : "none";
}

function exportarAtencionesExcel() {
  if (!clienteActualAtenciones) {
    alert("No hay suministro seleccionado");
    return;
  }

  const filas = atenciones
    .filter(a => a.cliente === clienteActualAtenciones)
    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

  if (filas.length === 0) {
    alert("Este suministro no tiene atenciones");
    return;
  }

  let csv = "Ticket;Tipo;Fecha;Alimentador;SED;Fuente\n";

  filas.forEach(a => {
    csv += `"${a.ticket}";"${a.tipo}";"${a.fecha}";"${a.alim}";"${a.sed}";"${a.fuente}"\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = `Atenciones_${clienteActualAtenciones}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

</script>
<!-- MODAL DETALLE SED -->
<div class="modal fade" id="detalleSEDModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">ğŸ” Detalle de SED</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 id="detalleSEDNombre" class="text-primary mb-3"></h6>
        <table class="table table-sm table-striped">
          <thead>
            <tr><th>Llave</th><th>Clientes</th></tr>
          </thead>
          <tbody id="tablaDetalleSED"></tbody>
        </table>
        <div id="totalClientesSED" class="fw-bold text-end"></div>
      </div>
</div>
</div>
</div>
</div>
</body>
</html>
