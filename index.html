<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Buscador de Suministros</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { margin: 0; height: 100vh; display: flex; overflow: hidden; }
  #sidebar {
    width: 320px; background: #f8f9fa; padding: 15px; overflow-y: auto; transition: all 0.3s ease;
  }
  #sidebar.hidden { transform: translateX(-100%); }
  #map { flex: 1; }
  .fade-in { animation: fadeIn 0.5s ease-in-out; }
  @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
  .toggle-btn {
    position: absolute; top: 10px; left: 10px; z-index: 1000;
  }
  #loginScreen {
    position: fixed; top:0; left:0; width:100%; height:100%; 
    background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center;
    z-index:2000;
  }
  #loginBox {
    background:white; padding:20px; border-radius:8px; width:300px; text-align:center;
  }
  #loginBox img {
    width: 120px;
    margin-bottom: 15px;
  }
</style>
</head>
<body>
<div id="loginScreen">
  <div id="loginBox">
    <!-- üîπ Logo arriba -->
    <img src="https://dl.dropboxusercontent.com/scl/fi/ymb0if0252ui58cy1voe2/logo-pluz.jpg?rlkey=ghj6tdtn6ccldppjyhj4a2zve&st=rnllbm7y" alt="Logo Pluz">
    
    <h4 class="mb-3">üîê Iniciar sesi√≥n</h4>
    <div class="mb-2">
      <input type="text" id="user" class="form-control" placeholder="Usuario">
    </div>
    <div class="mb-2">
      <input type="password" id="pass" class="form-control" placeholder="Contrase√±a">
    </div>
    <button class="btn btn-primary w-100" onclick="login()">Ingresar</button>
    <div id="loginMsg" class="text-danger mt-2"></div>
  </div>
</div>

<button class="btn btn-primary toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
<div id="sidebar">
  <h4>üîé Buscar suministro</h4>
  <div class="input-group mb-2">
    <input type="text" id="searchBox" class="form-control" placeholder="N√∫mero de cliente">
    <button class="btn btn-success" onclick="buscarSuministro()">Buscar</button>
  </div>
  <div id="resultado" class="text-success mb-2"></div>
  <button id="verEnGoogle" class="btn btn-outline-primary btn-sm mb-3" style="display:none" onclick="abrirEnGoogleMaps()">Ver en Google Maps</button>
  
  <div id="progresoBox">
    <h6>üìÇ Progreso de carga:</h6>
    <div class="progress mb-2">
      <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
    </div>
    <ul id="progreso" class="list-group small mb-3"></ul>
  </div>

  <h6>üìç Suministros cercanos (&lt;20m):</h6>
  <ul id="cercanos" class="list-group small mb-3"></ul>

  <h6>üïë Historial (√∫ltimos 3):</h6>
  <ul id="historial" class="list-group small"></ul>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let datos = [];
let ultimoEncontro = null;
let map, marker;
let historial = [];
let cercanosMarkers = [];
let cargados = 0;

const usuarios = [{user:"despachobt", pass:"Pluz2025"}];

function login(){
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value.trim();
  const ok = usuarios.find(x=>x.user===u && x.pass===p);
  if(ok){
    document.getElementById("loginScreen").style.display="none";
  } else {
    document.getElementById("loginMsg").textContent="‚ùå Usuario o contrase√±a incorrectos";
  }
}

const urls = [
  {nombre: "NORTE CHICO", url: "https://dl.dropboxusercontent.com/scl/fi/gq78aaeeowpllmk6aq6u8/NORTE-CHICO.csv?rlkey=amoh5m764nbkoobv8tggbbmhb"},
  {nombre: "COLONIAL", url: "https://dl.dropboxusercontent.com/scl/fi/mo1wrl48ky5v74l3ybfpd/COLONIAL.csv?rlkey=jhcfg302k4re8lnp5aya8o02n"},
  {nombre: "PANAMERICANA", url: "https://dl.dropboxusercontent.com/scl/fi/qpt0c6dqyhututunxgby5/PANAMERICANA.csv?rlkey=gtkcg709xhcohqdu70v8fzo16"}
];

// Progreso
function actualizarProgreso(){
  cargados++;
  const porcentaje = Math.round((cargados / urls.length) * 100);
  const bar = document.getElementById("progress-bar");
  bar.style.width = porcentaje + "%";
  bar.textContent = porcentaje + "%";
  if(cargados === urls.length){
    bar.classList.remove("progress-bar-animated");
    let li = document.createElement("li");
    li.className = "list-group-item text-success";
    li.textContent = "‚úÖ Todos los archivos cargados con √©xito.";
    document.getElementById("progreso").appendChild(li);

    // üî• Ocultar despu√©s de 2s
    setTimeout(()=>{ document.getElementById("progresoBox").style.display="none"; }, 2000);
  }
}

// Cargar CSV
urls.forEach(f => {
  fetch(f.url)
    .then(r => r.text())
    .then(texto => {
      const lineas = texto.split("\n");
      lineas.slice(1).forEach(l => {
        const cols = l.trim().split(";");
        if(cols.length >= 4){
          datos.push({
            cliente: cols[0].trim(),
            ut: cols[1].trim(),
            lat: parseFloat(cols[2].replace(",", ".")),
            lon: parseFloat(cols[3].replace(",", "."))
          });
        }
      });
      actualizarProgreso();
      let li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = f.nombre + ": " + lineas.length + " filas cargadas";
      document.getElementById("progreso").appendChild(li);
    })
    .catch(err => {
      let li = document.createElement("li");
      li.className = "list-group-item text-danger";
      li.textContent = "‚ùå Error al cargar " + f.nombre;
      document.getElementById("progreso").appendChild(li);
    });
});

function buscarSuministro(){
  if(cargados < urls.length){
    document.getElementById('resultado').textContent = "‚ö†Ô∏è Espera a que termine la carga.";
    return;
  }

  const num = document.getElementById('searchBox').value.trim();
  const encontrado = datos.find(d => d.cliente === num);
  if (encontrado){
    ultimoEncontro = encontrado;
    document.getElementById('resultado').textContent = '‚úÖ Encontrado en ' + encontrado.ut;
    document.getElementById('verEnGoogle').style.display = 'inline';
    actualizarMapa(encontrado.lat, encontrado.lon, encontrado);

    // Historial (m√°x 3 √∫ltimos)
    historial.unshift(encontrado);
    if(historial.length > 3) historial.pop();
    renderHistorial();

    // Cercanos <20m y solo 5 m√°s cercanos
    const cercanos = datos
      .filter(d => d !== encontrado)
      .map(d => ({...d, dist: getDistance(encontrado.lat, encontrado.lon, d.lat, d.lon)}))
      .filter(d => d.dist <= 0.02)
      .sort((a,b) => a.dist - b.dist)
      .slice(0,5);

    renderCercanos(cercanos);
  } else {
    document.getElementById('resultado').textContent = '‚ùå Suministro no encontrado';
    document.getElementById('verEnGoogle').style.display = 'none';
    document.getElementById('cercanos').innerHTML = '';
    document.getElementById('historial').innerHTML = '';
  }
}

function renderHistorial(){
  const ul = document.getElementById("historial");
  ul.innerHTML = "";
  historial.forEach(h => {
    const li = document.createElement("li");
    li.className = "list-group-item list-group-item-action";
    li.textContent = h.cliente + " ("+h.ut+")";
    li.onclick = () => {
      document.getElementById('searchBox').value = h.cliente;
      buscarSuministro();
    };
    ul.appendChild(li);
  });
}

function renderCercanos(lista){
  const ul = document.getElementById("cercanos");
  ul.innerHTML = "";
  cercanosMarkers.forEach(m => map.removeLayer(m));
  cercanosMarkers = [];

  lista.forEach(c => {
    const li = document.createElement("li");
    li.className = "list-group-item fade-in";
    li.textContent = "Cliente " + c.cliente + " - " + (c.dist*1000).toFixed(1) + " m";
    ul.appendChild(li);

    let mark = L.circleMarker([c.lat, c.lon], {radius:6, color:"gray"}).addTo(map);
    mark.bindTooltip("Cliente: " + c.cliente + "<br>UT: " + c.ut);
    cercanosMarkers.push(mark);
  });
}

function actualizarMapa(lat, lon, encontrado){
  if (!map){
    map = L.map('map').setView([lat, lon], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data ¬© OpenStreetMap contributors'
    }).addTo(map);
  }
  if(marker) map.removeLayer(marker);
  marker = L.marker([lat, lon], {title:"Cliente " + encontrado.cliente}).addTo(map);
  marker.bindTooltip("Cliente: " + encontrado.cliente + "<br>UT: " + encontrado.ut).openTooltip();
  map.setView([lat, lon], 17, {animate:true});
}

function abrirEnGoogleMaps(){
  if(ultimoEncontro){
    const url = `https://www.google.com/maps/search/?api=1&query=${ultimoEncontro.lat},${ultimoEncontro.lon}`;
    window.open(url, '_blank');
  }
}

function getDistance(lat1, lon1, lat2, lon2){
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)*Math.sin(dLat/2)+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)* 
    Math.sin(dLon/2)*Math.sin(dLon/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("hidden");
}
</script>
</body>
</html>
